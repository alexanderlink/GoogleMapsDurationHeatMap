<!DOCTYPE html>
<!--
  #%L
  Google Maps Duration Heat Map
  %%
  Copyright (C) 2015 Alexander Link
  %%
  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at
  
       http://www.apache.org/licenses/LICENSE-2.0
  
  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
  #L%
  -->
<html>
  <head>
    <title>Google Maps Duration Heat Map</title>
    <script src="http://maps.googleapis.com/maps/api/js?v=3.exp&signed_in=true"></script>
    <script src="http://cdnjs.cloudflare.com/ajax/libs/q.js/0.9.2/q.min.js"></script>
    <script>
var map;
var markersArray = {};
var areas = {};
var processed = -1;

var service;
var directionsService;
var directionsDisplay;
var deltaX, deltaY;
var sleep;
var rounds;
var minSleep = 2500;
var allOrigins = [];


var destination = new google.maps.LatLng(49.2936688, 8.6417212);

function initialize() {
  var opts = {
    center: new google.maps.LatLng(49.2936688, 8.6417212),
    zoom: 10
  };
  map = new google.maps.Map(document.getElementById('map-canvas'), opts);
  service = new google.maps.DistanceMatrixService();
  directionsService = new google.maps.DirectionsService();
  directionsDisplay = new google.maps.DirectionsRenderer();
  directionsDisplay.setMap(map);
}

function getLocationKey(location) {
    return location.A.toFixed(7)+'/'+location.F.toFixed(7);
}

function calculateOrigins(dest, count) {
  var origins = [];
  for(var i = 0; i < count; i++) {
    for(var j = 0; j < count; j++) {
      var lat = dest.lat() - (deltaX*count/2.0) + (deltaX/2.0) + (deltaX*i);
      var lng = dest.lng() - (deltaY*count/2.0) + (deltaY/2.0) + (deltaY*j);
      var location = new google.maps.LatLng(lat, lng);
      var key = getLocationKey(location);
      var rectangle = markersArray[key];
      if(rectangle) {
        //logInfo('Skipping ' + key);
      } else {
        origins.push(location);
      }
    }
  }
  logInfo('calculateOrigins: ' + origins.length);
  return origins;
}

function calcColor(min, max, value) {
  var percent = (value-min) / (max-min);
  if(percent <= 0.05) return '#00ff00'
  if(percent <= 0.15) return '#00df00'
  if(percent <= 0.25) return '#1fbf00'
  if(percent <= 0.35) return '#3f9f00'
  if(percent <= 0.45) return '#5f7f00'
  if(percent <= 0.55) return '#7f5f00'
  if(percent <= 0.65) return '#9f3f00'
  if(percent <= 0.75) return '#bf1f00'
  if(percent <= 0.85) return '#df0000'
  if(percent <= 0.95) return '#ff0000';
  if(percent <= 1.00) return '#ff0000';
  return '#0000ff';
}

function markRectangles(areas) {
  var max = 0;
  var min = 999999999;
  Object.keys(areas).forEach(function(key) {
    var area = areas[key];
    min = Math.min(min, area.duration.value);
    max = Math.max(max, area.duration.value);
  });
  Object.keys(areas).forEach(function(key) {
    var area = areas[key];
    markRectangle(area.origin, calcColor(min, max, area.duration.value), area.duration.text, area.distance.text);
  });  
}

function markRectangle(location, color, durationText, distanceText) {
    var lat = location.A;
    var lng = location.F;
    var key = getLocationKey(location);
    var rectangle = markersArray[key];
    if(rectangle) {
        rectangle.setMap(null);
        rectangle = null;
    }
    rectangle = new google.maps.Rectangle({
      strokeColor: color,
      strokeOpacity: 0.55,
      strokeWeight: 0.2,
      fillColor: color,
      fillOpacity: 0.5,
      map: map,
      bounds: new google.maps.LatLngBounds(
        new google.maps.LatLng(lat-(deltaX/2.0), lng-(deltaY/2.0)),
        new google.maps.LatLng(lat+(deltaX/2.0), lng+(deltaY/2.0))
      )
    });
    markersArray[key] = rectangle;
    google.maps.event.addListener(rectangle, 'click', function() {
      document.getElementById('duration').value = durationText;
      document.getElementById('distance').value = distanceText;
      document.getElementById('from').value = lat + ', ' + lng;
      document.getElementById('to').value = destination.lat() + ', ' + destination.lng();
      checkRoute(location);
    });
}

function checkRoute(location) {
  /*service.getDistanceMatrix(
    {
      origins: [location],
      destinations: [destination],
      travelMode: google.maps.TravelMode.DRIVING,
      unitSystem: google.maps.UnitSystem.METRIC,
      avoidHighways: false,
      avoidTolls: false
    }, 
    function(response, status) {
      logInfo(JSON.stringify(response, null, '  '));
    });*/
  directionsService.route({origin: location, destination: destination, travelMode: google.maps.TravelMode['DRIVING']},
  function(response, status) {
    if (status == google.maps.DirectionsStatus.OK) {
      directionsDisplay.setDirections(response);
    }
  });
}

function partial(funct) {
    var args = Array.prototype.slice.call(arguments).splice(1);
    return function() {
      var allArgs = args.concat(Array.prototype.slice.call(arguments));
      return funct.apply(this, allArgs);
    };
}

function processRecursive(i, rounds, timeout) {
  var deferred = Q.defer();
  if(!timeout) timeout = 0;
  console.log('processRecursive ' + i + ', ' + rounds + ', ' + timeout + ' - left: ' + ((rounds-i) * timeout / 1000 / 60));
  setTimeout(partial(function(i, rounds, timeout){ 
    var maxPerRequest = 25;
    var start = i*maxPerRequest;
    var end = start+maxPerRequest;
    if(end > allOrigins.length) end = allOrigins.length;
    if(end > start) {
      var origins = allOrigins.slice(start, end);
      service.getDistanceMatrix(
      {
        origins: origins,
        destinations: [destination],
        travelMode: google.maps.TravelMode.DRIVING,
        unitSystem: google.maps.UnitSystem.METRIC,
        avoidHighways: false,
        avoidTolls: false
      }, partial(function(origins, response, status) {
        logInfo('Iteration['+i+']: ' + status + ' - Remaining: ' + ((rounds-i) * timeout / 1000 / 60) + 'min');
        callback(i, origins, response, status).then(
          function success() {
            if(i < rounds) {
              markRectangles(areas);
              processRecursive(i+1, rounds, minSleep).then(
                function success2() {
                  deferred.resolve();
                },
                function error2(err) {
                  deferred.reject(err);
                }
              )
            } else {
              deferred.resolve();
            }
          },
          function error(err) {
            if(err === "OVER_QUERY_LIMIT") {
              if(timeout < minSleep) timeout = minSleep
              else timeout = timeout * 2;
              console.log('OVER_QUERY_LIMIT - increasing to ' + timeout);
              processRecursive(i, rounds, timeout).then(
                function success2() {
                  deferred.resolve();
                },
                function error2(err) {
                  deferred.reject(err);
                }
              )
            } else {
              deferred.reject(err);
            }
          }
        );
      }, origins));
    } else {
      deferred.resolve();
    }
  }, i, rounds, timeout), timeout);
  return deferred.promise;
}

function callback(iteration, reqOrigins, response, status) {
  var deferred = Q.defer();
  try {
    if (status != google.maps.DistanceMatrixStatus.OK) {
      if(status !== "OVER_QUERY_LIMIT") logError('Error1 was: ' + status + ' / ' + JSON.stringify(response));
      deferred.reject(status);
    } else {
      for (var i = 0; i < reqOrigins.length; i++) {
        var origin = reqOrigins[i];
        var result = response.rows[i].elements[0];
        if(origin) {
          if(result && result.distance && result.duration) {
            areas[origin.lat()+'/'+origin.lng()] = {origin: origin, distance: result.distance, duration: result.duration};
            logDetails(iteration + '/' + rounds + '  ' + origin.lat() + ' / ' + origin.lng() + ' : ' + result.distance.text + ' in '+ result.duration.text);
          } else {
            console.warn('result incomplete i: ' + i + ', iteration: ' + iteration + ' - ' + result);
          }
        } else {
          console.warn('origin undefined i: ' + i + ', iteration: ' + iteration);
        }
      }
      deferred.resolve();
    }
  } catch(err) {
    logError('Error2 was: ' + err);
    deferred.reject(err);
  }
  return deferred.promise;
}

function addMarker(reqLocation) {
  var marker = new google.maps.Marker({
      map: map,
      position: reqLocation,
      icon: 'https://chart.googleapis.com/chart?chst=d_map_pin_letter&chld=D|FF0000|000000'
    });
  markersArray['destination'] = marker;
}

function logError(err) {
  var div = document.getElementById('errorDiv');
  div.innerHTML = err + '<br>' + div.innerHTML;
}

function logInfo(message) {
  var div = document.getElementById('outputDiv');
  div.innerHTML = message + '<br>' + div.innerHTML;
}

function logDetails(message) {
  //TODO
}

function deleteOverlays() {
  Object.keys(markersArray).forEach(function(key) {
    markersArray[key].setMap(null);
  });
  markersArray = {};
}

function runIteration(iter) {
    var deferred = Q.defer();
    logInfo('Run Iteration ' + iter);
    allOrigins = calculateOrigins(destination, iter);
    rounds = allOrigins.length/25;
    processRecursive(0, rounds).then(
      function success() {
        document.getElementById("result").value = JSON.stringify(areas);
        markRectangles(areas);
        deferred.resolve();
      },
      function error(err) {
        logError('Some promises failed!');
        deferred.reject(err);
      }
    );
    return deferred.promise;
}

function calculateDistances() {
  deleteOverlays();
  addMarker(destination);
  if(document.getElementById("result").value) {
    areas = JSON.parse(document.getElementById("result").value);
    markRectangles(areas);
  } else {
    deltaX = Number(document.getElementById("delta").value);
    deltaY = deltaX * 1.5;
    countLocal = Number(document.getElementById("count").value);
    sleep = Number(document.getElementById("sleep").value);
    areas = {};
    var promise = runIteration(2);
    for(var i = 4; i <= countLocal; i+=2) {
        promise = promise.then(partial(runIteration, i));
    }
  }
}

google.maps.event.addDomListener(window, 'load', initialize);

    </script>
    <style>
      html, body {
        height: 100%;
        margin: 0;
        padding: 0;
      }

      #map-canvas {
        height: 100%;
        width: 70%;
      }
      #content-pane {
        float:right;
        width:28%;
        padding-left: 2%;
      }
      #outputDiv {
        font-size: 10px;
      }
      #errorDiv {
        font-size: 10px;
      }
    </style>
  </head>
  <body>
    <div id="content-pane">
      <div id="inputs">
        <p>
          <input type="text" id="delta" value="0.005" size="12"></input> 
          <input type="text" id="count" value="8" size="12"></input> 
          <input type="text" id="sleep" value="3000" size="12"></input> <br/>
          <button type="button" onclick="calculateDistances();">Calculate distances</button> <br/>
          <input type="text" id="distance" value="km" size="12" readonly></input> 
          <input type="text" id="duration" value="min" size="12" readonly></input> <br/>
          <input type="text" id="from" value="from" size="40" readonly></input> <br/>
          <input type="text" id="to" value="to" size="40" readonly></input><br/>
          <input type="text" id="result" value="" size="40"></input>
        </p>
      </div>
      <div id="errorDiv" style="color:red"></div>
      <div id="outputDiv"></div>
    </div>
      
    <div id="map-canvas"></div>
  </body>
</html>

